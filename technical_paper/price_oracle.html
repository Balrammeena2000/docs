<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Asset Price Oracle</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="Y Combinator of Steem Blockchain">
    <link rel="preload" href="/assets/css/0.styles.f317dd00.css" as="style"><link rel="preload" href="/assets/js/app.d9185879.js" as="script"><link rel="preload" href="/assets/js/2.e08193f9.js" as="script"><link rel="preload" href="/assets/js/40.8a0fc226.js" as="script"><link rel="prefetch" href="/assets/js/10.5c6b18a1.js"><link rel="prefetch" href="/assets/js/11.b5984e93.js"><link rel="prefetch" href="/assets/js/12.84747f73.js"><link rel="prefetch" href="/assets/js/13.db23bb43.js"><link rel="prefetch" href="/assets/js/14.13b8e19c.js"><link rel="prefetch" href="/assets/js/15.325670b9.js"><link rel="prefetch" href="/assets/js/16.37eb33e5.js"><link rel="prefetch" href="/assets/js/17.3f3f9226.js"><link rel="prefetch" href="/assets/js/18.cef99a58.js"><link rel="prefetch" href="/assets/js/19.552c8b04.js"><link rel="prefetch" href="/assets/js/20.97f3888c.js"><link rel="prefetch" href="/assets/js/21.c52eb862.js"><link rel="prefetch" href="/assets/js/22.20ba88aa.js"><link rel="prefetch" href="/assets/js/23.5da0a496.js"><link rel="prefetch" href="/assets/js/24.d0827e58.js"><link rel="prefetch" href="/assets/js/25.735977ea.js"><link rel="prefetch" href="/assets/js/26.e78f0a2f.js"><link rel="prefetch" href="/assets/js/27.bb16ed7b.js"><link rel="prefetch" href="/assets/js/28.081cde7f.js"><link rel="prefetch" href="/assets/js/29.6ccd99b6.js"><link rel="prefetch" href="/assets/js/3.7cdb0e93.js"><link rel="prefetch" href="/assets/js/30.0ac7d901.js"><link rel="prefetch" href="/assets/js/31.2ca17e31.js"><link rel="prefetch" href="/assets/js/32.9ada2132.js"><link rel="prefetch" href="/assets/js/33.aca08b1a.js"><link rel="prefetch" href="/assets/js/34.56e0d3f9.js"><link rel="prefetch" href="/assets/js/35.066c36fd.js"><link rel="prefetch" href="/assets/js/36.5fc96723.js"><link rel="prefetch" href="/assets/js/37.a5ad4e2c.js"><link rel="prefetch" href="/assets/js/38.dbeb017d.js"><link rel="prefetch" href="/assets/js/39.f373c73d.js"><link rel="prefetch" href="/assets/js/4.d9591209.js"><link rel="prefetch" href="/assets/js/41.c466891f.js"><link rel="prefetch" href="/assets/js/42.3ae70ef4.js"><link rel="prefetch" href="/assets/js/43.489806b9.js"><link rel="prefetch" href="/assets/js/44.99ef0ec8.js"><link rel="prefetch" href="/assets/js/45.ba26d4a6.js"><link rel="prefetch" href="/assets/js/46.8a867664.js"><link rel="prefetch" href="/assets/js/47.b93963d2.js"><link rel="prefetch" href="/assets/js/48.70e7d02e.js"><link rel="prefetch" href="/assets/js/49.46780328.js"><link rel="prefetch" href="/assets/js/5.5e3aa421.js"><link rel="prefetch" href="/assets/js/50.7cd7eb7e.js"><link rel="prefetch" href="/assets/js/51.1f784e08.js"><link rel="prefetch" href="/assets/js/52.322cc3ad.js"><link rel="prefetch" href="/assets/js/53.1473b7ed.js"><link rel="prefetch" href="/assets/js/54.82fccb3f.js"><link rel="prefetch" href="/assets/js/6.e69dd2b3.js"><link rel="prefetch" href="/assets/js/7.2d95718b.js"><link rel="prefetch" href="/assets/js/8.99be4a52.js"><link rel="prefetch" href="/assets/js/9.17f7013a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f317dd00.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/lite_paper_v2/" class="nav-link">
  Lite Paper v2
</a></div><div class="nav-item"><a href="/lite_paper_v1/" class="nav-link">
  Lite Paper v1
</a></div><div class="nav-item"><a href="/white_paper/" class="nav-link">
  White Paper
</a></div><div class="nav-item"><a href="/technical_paper/" class="nav-link router-link-active">
  Technical Paper
</a></div><div class="nav-item"><a href="/donut/" class="nav-link">
  Donut
</a></div> <a href="https://github.com/nutbox-dao/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/lite_paper_v2/" class="nav-link">
  Lite Paper v2
</a></div><div class="nav-item"><a href="/lite_paper_v1/" class="nav-link">
  Lite Paper v1
</a></div><div class="nav-item"><a href="/white_paper/" class="nav-link">
  White Paper
</a></div><div class="nav-item"><a href="/technical_paper/" class="nav-link router-link-active">
  Technical Paper
</a></div><div class="nav-item"><a href="/donut/" class="nav-link">
  Donut
</a></div> <a href="https://github.com/nutbox-dao/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/technical_paper/background.html" class="sidebar-link">Background</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical_paper/background.html#nutbox-contracts" class="sidebar-link">Nutbox Contracts</a></li><li class="sidebar-sub-header"><a href="/technical_paper/background.html#nutbox-parachain" class="sidebar-link">Nutbox Parachain</a></li></ul></li><li><a href="/technical_paper/ocsp.html" class="sidebar-link">Open Community Staking Protocol(OCSP) Contract</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical_paper/ocsp.html#contract-topology" class="sidebar-link">Contract Topology</a></li><li class="sidebar-sub-header"><a href="/technical_paper/ocsp.html#multi-chain-ttoken" class="sidebar-link">Multi-Chain tToken</a></li><li class="sidebar-sub-header"><a href="/technical_paper/ocsp.html#community-token-ctoken-mining-distribution" class="sidebar-link">Community Token(cToken) Mining &amp; Distribution</a></li></ul></li><li><a href="/technical_paper/bridge.html" class="sidebar-link">Crosschain Bridge</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical_paper/bridge.html#what-is-crosschain-bridge" class="sidebar-link">What Is Crosschain Bridge</a></li><li class="sidebar-sub-header"><a href="/technical_paper/bridge.html#light-trustless-blokchain-state-verification-ltbsv" class="sidebar-link">Light Trustless Blokchain State Verification(LTBSV)</a></li></ul></li><li><a href="/technical_paper/parachain.html" class="sidebar-link">Nutbox As Parachain</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical_paper/parachain.html#nutbox-collator" class="sidebar-link">Nutbox Collator</a></li><li class="sidebar-sub-header"><a href="/technical_paper/parachain.html#xcm-based-transfer" class="sidebar-link">XCM Based Transfer</a></li></ul></li><li><a href="/technical_paper/price_oracle.html" class="active sidebar-link">Asset Price Oracle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical_paper/price_oracle.html#price-oracle-algorithm" class="sidebar-link">Price Oracle Algorithm</a></li><li class="sidebar-sub-header"><a href="/technical_paper/price_oracle.html#offchain-worker-based-price-oracle-flow" class="sidebar-link">Offchain Worker Based Price Oracle Flow</a></li></ul></li><li><a href="/technical_paper/governance_contracts.html" class="sidebar-link">Nutbox Governance Contracts</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#democracy" class="sidebar-link">Democracy</a></li><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#collective" class="sidebar-link">Collective</a></li><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#elections" class="sidebar-link">Elections</a></li><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#membership" class="sidebar-link">Membership</a></li><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#treasury" class="sidebar-link">Treasury</a></li><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#multisig" class="sidebar-link">Multisig</a></li><li class="sidebar-sub-header"><a href="/technical_paper/governance_contracts.html#sudo" class="sidebar-link">Sudo</a></li></ul></li><li><a href="/technical_paper/references.html" class="sidebar-link">References</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="asset-price-oracle"><a href="#asset-price-oracle" class="header-anchor">#</a> Asset Price Oracle</h1> <h2 id="price-oracle-algorithm"><a href="#price-oracle-algorithm" class="header-anchor">#</a> Price Oracle Algorithm</h2> <p>由上文可知Asset的种类是多种多样的，这个章节我们暂时只针对Concrete Fungible Asset的价格进行讨论。价格获取预言机一直以来都是行业内一个非常值得探索的技术分支，通常包含价格计算和喂价两个阶段。目前有很多实现能够满足基本的业务需求，Nutbox对资产价格获取参考了Uniswap的Price Oracle实现[7]。对于一般资产入BTC、ETH，我们可以通过Uniswap交易对来推导出对于资产的价格。由于在Uniswap中，交易对TokenA-TokenB拥有恒定乘积K，每一个交易对都可以最终被推导为Token-USDT，</p> <p>因此此时资产价格可以表示为：</p> <p><img src="http://wherein.mobi/wp-content/uploads/2021/03/1.png" alt="Image text"></p> <p>资产余额表示为：</p> <p><img src="http://wherein.mobi/wp-content/uploads/2021/03/2.png" alt="Image text"></p> <p>创建一个交易对，</p> <p><img src="http://wherein.mobi/wp-content/uploads/2021/03/3.png" alt="Image text"></p> <p>Nutbox不仅支持一般资产的抵押，也支持LP token的抵押。LP token抵押依赖LP token的价格预言机，而在价格预言机实现中LP token的价格获取有一定的特殊性。通常LP token的价格计算表示为：</p> <p><img src="http://wherein.mobi/wp-content/uploads/2021/03/4.png" alt="Image text"></p> <p>其中，r0,r1 分别为 Uniswap 对应交易对中两种资产的数量，price0，price1 分别对应 r0 和 r1 对应代币的价格。上面的公式简单来说就是算出交易对中两种代币的总价值之和，然后除以 LP Token 的总数量，由此得到LP token的价格。而实践中这种价格计算方式容易被黑客攻击，因为黑客能够很容易的通过交易池交易来操纵r0和r1。因此参考Alpha Finance的LP Token价格获取算法[9]，一个更好的LP Token价格获取算法表示为：</p> <p><img src="http://wherein.mobi/wp-content/uploads/2021/03/5.png" alt="Image text"></p> <p>由上式可以看出，黑客针对r0和r1的攻击导致的后果从r0 + r1 减少到sqrt{r0} + sqrt{r1}。该算法实现基于Uniswap的交易对曲线恒定乘积K，因此只适用于基于此交易模型的交易对LP Token价格计算。</p> <h2 id="offchain-worker-based-price-oracle-flow"><a href="#offchain-worker-based-price-oracle-flow" class="header-anchor">#</a> Offchain Worker Based Price Oracle Flow</h2> <p>目前的substrate提供了Offchain Worker[10]机制，可以让节点通过http获取外部数据，执行复杂计算如加解密等。Offchain Worker拥有Offchain Storage，runtime可以直接访问；在Offchain Worker的pallet里可以访问其他pallet，同时Offchain Worker也可以提供提交Signed Transaction和Unsigned Transaction提交需要共识验证的数据。</p> <p>基于Offchain Worker模块的价格预言机利用http协议从第三方价格提供者那获取价格信息，并依照价格计算算法计算出资产价格，然后将价格提交到Nutbox网络中。</p> <p><img src="http://wherein.mobi/wp-content/uploads/2021/03/OCW-Based-Price-Fetcher-Flow.png" alt="Image text"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/nutbox-dao/docs/edit/master/book/technical_paper/price_oracle.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/3/2021, 5:02:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technical_paper/parachain.html" class="prev">
        Nutbox As Parachain
      </a></span> <span class="next"><a href="/technical_paper/governance_contracts.html">
        Nutbox Governance Contracts
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d9185879.js" defer></script><script src="/assets/js/2.e08193f9.js" defer></script><script src="/assets/js/40.8a0fc226.js" defer></script>
  </body>
</html>
